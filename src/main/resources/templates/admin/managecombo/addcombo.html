<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Tạo Combo Mới</title>
    <meta charset="UTF-8">
    <style>
        .container { display: flex; gap: 40px; }
        .list { border: 1px solid #ccc; padding: 20px; width: 40%; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
        th { background-color: #f2f2f2; }
        input, select { margin-bottom: 10px; width: 100%; padding: 5px; }
        button { padding: 5px 10px; }
    </style>
</head>
<body>

<h1>Tạo Combo Mới</h1>

<form th:action="@{/admin/manageCombo/create}" th:object="${combo}" method="post">

    <p>
        <label>Tên combo:
            <input type="text" th:field="*{name}" required maxlength="30"
                   oninvalid="this.setCustomValidity('Tên combo không được để trống và tối đa 30 ký tự')"
                   oninput="this.setCustomValidity('')">
        </label>
    </p>

    <p>
        <label>Mô tả:
            <input type="text" th:field="*{description}" maxlength="120"
                   oninvalid="this.setCustomValidity('Mô tả tối đa 120 ký tự')"
                   oninput="this.setCustomValidity('')">
        </label>
    </p>

    <p>
        <label>Giá:
            <input type="number" th:field="*{price}" required min="1"
                   oninvalid="this.setCustomValidity('Giá phải lớn hơn 0')"
                   oninput="this.setCustomValidity('')">
        </label>
    </p>

    <p>
        <label>Mở bán:
            <input type="checkbox" th:field="*{available}">
        </label>
    </p>

    <!-- Phần chọn món ăn giữ nguyên -->
    <div class="container">
        <!-- Danh sách món ăn -->
        <div class="list">
            <h3>Danh sách món ăn</h3>

            <input type="text" id="searchInput" placeholder="Tìm kiếm món ăn">
            <select id="categoryFilter">
                <option value="">Tất cả</option>
                <option th:each="cat : ${categories}" th:value="${cat}" th:text="${cat}"></option>
            </select>

            <table>
                <thead>
                    <tr><th>Tên món</th><th>Thêm</th></tr>
                </thead>
                <tbody id="itemTable">
                    <tr th:each="item : ${items}" th:id="'item-' + ${item.itemId}">
                        <td th:text="${item.name}"></td>
                        <td><button type="button" th:attr="onclick=|addItem(${item.itemId}, '${item.name}', '${item.category}')|">+</button></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- Danh sách món đã chọn -->
        <div class="list">
            <h3>Món ăn đã chọn</h3>
            <table>
                <thead><tr><th>Tên</th><th>Số lượng</th><th>Xóa</th></tr></thead>
                <tbody id="selectedTable"></tbody>
            </table>
        </div>
    </div>

    <div id="hiddenInputs"></div>

    <p><button type="submit">Tạo Combo</button></p>
</form>

<script th:inline="javascript">
    const allItems = /*[[${items}]]*/ [];

    const itemsData = allItems.map(item => ({
        id: item.itemId,
        name: item.name,
        category: item.category
    }));

    let selected = [];

    function addItem(id, name, category) {
        if (selected.find(i => i.id === id)) return;
        selected.push({id, name, category, quantity: 1});
        document.getElementById('item-' + id).style.display = 'none';
        renderSelected();
    }

    function removeItem(id) {
        selected = selected.filter(i => i.id !== id);
        document.getElementById('item-' + id).style.display = '';
        renderSelected();
    }

    function renderSelected() {
        const table = document.getElementById("selectedTable");
        const hidden = document.getElementById("hiddenInputs");
        table.innerHTML = "";
        hidden.innerHTML = "";

        selected.forEach(item => {
            table.innerHTML += `<tr>
                <td>${item.name}</td>
                <td><input type="number" value="${item.quantity}" min="1" onchange="changeQuantity(${item.id}, this.value)"></td>
                <td><button type="button" onclick="removeItem(${item.id})">-</button></td>
            </tr>`;
            hidden.innerHTML += `<input type="hidden" name="itemIds" value="${item.id}">`;
            hidden.innerHTML += `<input type="hidden" name="quantities" value="${item.quantity}">`;
        });
    }

    function changeQuantity(id, val) {
        const item = selected.find(i => i.id === id);
        item.quantity = parseInt(val);
        renderSelected();
    }

    document.getElementById("searchInput").addEventListener("input", filterItems);
    document.getElementById("categoryFilter").addEventListener("change", filterItems);

    function filterItems() {
        const search = document.getElementById("searchInput").value.toLowerCase();
        const category = document.getElementById("categoryFilter").value;

        itemsData.forEach(item => {
            const row = document.getElementById('item-' + item.id);
            if (selected.find(i => i.id === item.id)) return;
            const matchName = item.name.toLowerCase().includes(search);
            const matchCat = category === "" || item.category === category;
            row.style.display = (matchName && matchCat) ? "" : "none";
        });
    }
</script>

</body>
</html>
